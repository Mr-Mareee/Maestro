from langchain_openai import ChatOpenAI
from langgraph.prebuilt import create_react_agent
from tools.tools import tools
from .state import AgentState
from prompts import EXPLOIT_AGENT_PROMPT
from langchain_core.messages import AIMessage

def build_exploit_agent():
    """
    Exploitation Agent come ReAct.
    - Usa i tool (terminal_tool, self_rag_tool, ecc.)
    - Riceve dallo state il `shared_report` (solo per contesto)
    - NON aggiorna lo shared_report (compito del Reporter)
    """
    model = ChatOpenAI(model="gpt-4o", temperature=0)

    exploit_core = create_react_agent(
        model,
        tools=tools,
        prompt=EXPLOIT_AGENT_PROMPT,
    )

    def exploit_with_context(state: AgentState) -> AgentState:
        shared_report = state.get("shared_report", "Nessuna informazione precedente.")
        last_msg = state["messages"][-1]

        enriched_inputs = {
            "messages": [
                ("system", f"Contesto accumulato:\n{shared_report}"),
                ("user", last_msg.content if hasattr(last_msg, "content") else str(last_msg))
            ]
        }

        result = exploit_core.invoke(enriched_inputs)
        summary = "\n".join(m.content for m in result["messages"] if hasattr(m, "content"))
        exploit_msg = AIMessage(content=f"[Exploitation]\n{summary}", name="Exploitation")

        return {
            "messages": exploit_msg,
            "shared_report": shared_report
        }

    return exploit_with_context
